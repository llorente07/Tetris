<html>
    <head>
        <title>TETRIS Llorente</title>
        <meta http equiv="Content­Type" content="text/html;charset=iso­8859­1" />
    </head>
    <style type="text/css">
    
    .Mapa{
        border-collapse: collapse;
        position: absolute;
        /* MIG DEL NAVEGADOR */
        top:50%;
	left:50%;
	/* AMPLADA */
        width:400px;
        /* MARGE ESQUERRA / AMPLADA */
        margin-left:-200px;
	/* ALTURA */
	height:300px;
	/* MARGE SUPERIOR / (MITAD / ALTURA) */
	margin-top:-150px;
	border:1px solid #808080;
	padding:5px;
}
    
    .Mapa fila col{
        width:20px;
        height:20px;
        padding: 0px;
}

    </style>

    <script>
//INICIAR EL CODI
//DECLAREM LES VARIABLES PRINCIPALS
        var Tauler;
        var Pecaa = 0; //Contador de peça a 0
        var FilaP; //Fila de la peça
        var ColumnP; //Columna de la peça
        var RotacioP; //Rotacio de la peça
        var TOP = 0; //Puntuacio Record
        var ComL = 0; //Puntuacio de las lineas
        var pos = [
        [0, 0],
        [0, 1],
        [ - 1, 0],
        [1, 0],
        [ - 1, - 1],
        [0, - 1],
        [1, - 1],
        [0, - 2]
        ]; // Valor on estan els limits

        // Disseny de les peces.
        var peces = [
        [4, 0, 1, 2, 3],
        [4, 0, 1, 5, 6],
        [4, 0, 1, 5, 4],
        [2, 0, 1, 5, 7],
        [2, 0, 2, 5, 6],
        [2, 0, 3, 5, 4],
        [1, 0, 5, 6, 3]
        ];
        
//FUNCIO PER GENERAR LA PEÇA ALETORIAMENT
function NovaPeca(){
        ColumnP = 5; //COLUMNA ON LA PEÇA ES COLOCARA PER COMENÇAR
        FilaP = 0;
        RotacioP = 0; 
        Pecaa = Math.floor(Math.random()*7);
}
        
//FUNCIO PER INCIAR EL JOC I CARREGAR EL HTML
function Tetris() {
        IniciJoc();
        setTimeout(); //FALTA AFEGIR EL VALOR PER QUE FUNCIONI
        }

//FUNCIO PER INICIAR EL JOC I REINICIAR
function IniciJoc() {
        Moviment(); //PER CREAR
        Pintar();
        setTimeout(); // VELOCITAT DEL JOC Y CARREGA
        }

//GENERACIO DEL TAULER
function GenerarTauler() {
        Tauler = new Array(25);
        for (var y = 0; y < 24; y++) {
        Tauler [y] = new Array(10);
        for (var x = 0; x < 9; x++) {
        Tauler [y][x] = 0;
        }
    }
}
     
//MOURE LA PEÇA LATERALMENT PER ALS DOS COSTATS
function MourePecaLateral() {
        ColumnP += Mur;
        if (ColisioPeca){
        ColumnP -= Mur;
    }
}

//ROTACIO DE LA PEÇA, LA PEÇA COMENZA A LA POS 0
function RotacioPeca(){
        RotacioP = RotacioP + 1;
            if (RotacioP == peces [Pecaa] [0]){
            RotacioP = 0;
        }
        
        // SI COLISIONA NO POT ROTAR LA PEÇA
        if (ColisioPeca()){
        RotacioP = RotacioP - 1;
            if (RotacioP == - 1){
            RotacioP = peces [Pecaa] [0] - 1;
        }
    }
}

//FUNCIO PER PINTAR EL MAPA

function Dibuijar (){
        var Espai = " <";
        var Mur;
        var Div = "<table class = 'Mapa'>";
            for (var X = 0; X < 25; X++){
            Div += "<fila>";
                for (var Y = 0; Y < 10; Y++){
                var Fondo = Tauler [X][Y];
                    if(Fondo == 0){
                        for (i = 1; i < 5; i++){
                            Mur = peces [Pecaa][i];
                            var Pos2 = Rotacio (pos[Mur]);
                                if (X == FilaP + Pos2[0] && Y == ColumnP + Pos2[1]){
                                Fondo = Pecaa +1;    
                    }
                }
            }
            Div += "<col class='Figura" + Fondo + " '/>";
        }
        Div = Espai + "/fila>";
    }
    Div = Espai + "/Mapa>";
    
    document.getElementById ('Mapa').innerHTML = Div;
}

//NO FUNCIO ALGUNA COSAS FALTA ARREGLAR 
//FUNCIO PER BAIXAR LA PEÇA 
function BaixarPeca(){
        FilaP = FilaP + 1;
        if (ColisioPeca()){
            FilaP = FilaP - 1;
            for (i = 1;i < 5; i++){
                Mur =  peces [Pecaa][i];
                var Pos2=rotarCasilla(pos[Mur]);
                if (Pos2 [ 0 ] + FilaP >= 0 && Pos2 [ 0 ] + FilaP < 25 &&
                    Pos2 [ 1 ] +ColumnP >=0 && Pos2 [ 1 ] + ColumnP < 10){
                    Tauler [Pos2 [ 0 ] + FilaP][Pos2 [ 1 ] + ColumnP]= Pecaa + 1;
                }
            }
            // SI EN LA POS 0 TENIM UNA PEÇA REINICIA EL TETRIS
            Lineas();
            var reinici=0;
            for (var c=0;c < 9;c++){
                if (Tauler [ 0 ] [ c ] !=0){
                    reinici=1;
                }
            }
            if (reinici == 1) {
                if (ComL > TOP) {
                    TOP = ComL;
                }
                GenerarTauler();
            } else {
                GenerarTauler();
        }
    }
}
    

//FUNCIO PER COMPROBAR SI LA PEÇA COLISIONA AMB EL LIMITS DEL MAPA O AMB UNA ALTRE PEÇA 

function ColisioPeca (){
        for (var i = 1; i < 5; i ++){
            var Mur = peces [Pecaa] [i];
            var Pos2 = Rotar (Pos[Mur]);
                if (Pos2 [0] + FilaP, Pos2 [1] + ColumnP){
                return true;
        }
    }
    return false;
}

//FUNCIO PER ROTAR LA PEÇA
function Rotacio (Rota) {
        var Pos2 = [ Rota [0] , Rota [1] ];
            for (var i = 0; i < RotacioP ;i ++){
                var X = Pos2 [ 1 ]; 
                var Y = -Pos2 [ 0 ] ;
            
            Pos2 [ 0 ] = X;
            Pos2 [ 1 ] = Y;
        }
        
    return Pos2;
}

//DETECTA SI LA POSISICO ESTA LLIURE PER PODER SER OCUPADA
function PosNo (X, Y){
    if (X < 0) return false;
    return (Y < 0 || Y >= 9 || X >= 24 || Tauler[X][Y] > 0;)
    
}

//FUNCIO PER DETECTAR I CONTAR LES LINEAS FETAS
function Lineas(){
    for (var X = 0; X < 25; X++){
        var contador  = 0;
            for (var Y = 0; Y < 10; Y++){
                if (Tauler [X][Y] > 0){
                    contador ++;
                }
            }
            if (contador == 10){
                for (var X2 = X; X2 > 0; X2--){
                    for (var Y2 = 0; Y2 < 10; Y2 ++){
                        Tauler [X2][Y2] = Tauler [X2-1][Y2];
                }
            }
            ComL++;
        }
    }
}

//FUNCIA PER UTILIZAR EL TECLAT
// CODI DE LES TECLES:
// F.ESQUERRA   - 37
// F.ADALT      - 38
// F.DRETA      - 39
// F.ABAIX      - 40

function Teclat (e){
    var Tecla = (e && e.which)? e.which: e.keyCode;
    switch (Tecla) {
        case 37:
            MourePecaLateral (-1);
            break;
        
        case 38:
            RotacioPeca();
            break;
        
        case 39:
            MourePecaLateral (1);
            break;
        
        case 40:
            //BaixarPeca();
            //break;
    }
    Dibuixar();
}
      
    </script>
    <body onload='Tetris()' onkeydown = "TECLAT(event)"> 
    
        <div id='Mapa'/>
    
    </body>
</html>

